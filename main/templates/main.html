{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Mujur Reborn</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock meta %}
{% block content %}
{% include 'user_navbar.html' %}
<div id="addToCartModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full" style="z-index: 999;">
  <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
      <div class="mt-3">
          <h3 class="text-lg font-medium text-gray-900" id="modalProductName"></h3>
          <div class="mt-2">
              <p class="text-gray-500" id="modalProductPrice"></p>
              <form id="addToCartForm" class="mt-4">
                  {% csrf_token %}
                  <div class="mb-4">
                      <label class="block text-gray-700 text-sm font-bold mb-2" for="id_quantity">
                          Jumlah
                      </label>
                      <input type="number" name="quantity" id="id_quantity"
                          class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                          value="1" min="1">
                  </div>
                  <div class="flex items-center justify-between mt-4">
                      <button type="submit"
                          class="bg-[#FFAEBC] hover:bg-[#ff9eaf] text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                          Tambah ke Keranjang
                      </button>
                      <button type="button" onclick="closeModal()"
                          class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                          Batal
                      </button>
                  </div>
              </form>
          </div>
      </div>
  </div>
</div>

<div class="overflow-x-hidden px-4 md:px-8 pb-8 pt-24 min-h-screen bg-white flex flex-col">
  <div class="p-2 mb-6 relative">
    <div class="h-full w-full py-6  absolute top-0 left-0 z-20 md:hidden flex ">
      <div class="h-full min-w-4 bg-[#FFAEBC] mx-auto">
      </div>
    </div>
  </div>

    <div class="flex flex-row justify-between items-center mb-6">
      <div class="flex items-center space-x-4">
        <select class="border rounded p-2" id="filter-kategori">
          <option value="">Filter berdasarkan kategori</option>
          <option value="Dasi Instant">Dasi Instant</option>
          <option value="Dasi Manual">Dasi Manual</option>
          <option value="Dasi Kupu-Kupu">Dasi Kupu-Kupu</option>
          <option value="Jepitan Dasi">Jepitan Dasi</option>
        </select>
      </div>
      <div class="flex rounded-md items-center bg-[#444445] py-1 px-2 w-fit opacity-80">
        <h1 class="text-white text-center text-sm">Last Login at: {{last_login}}</h1>
      </div>
    </div>

    <div id="product_entry_cards" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 w-full"></div>
</div>

<script>
  let currentProductId = null;

  function openModal(productId, productName, productPrice) {
      currentProductId = productId;
      document.getElementById('modalProductName').textContent = productName;
      document.getElementById('modalProductPrice').textContent = `Rp${productPrice}`;
      document.getElementById('addToCartModal').classList.remove('hidden');
  }

  function closeModal() {
      document.getElementById('addToCartModal').classList.add('hidden');
      document.getElementById('id_quantity').value = '1';
      currentProductId = null;
  }

  // AJAX form submission
  $(document).ready(function() {
      $('#addToCartForm').on('submit', function(e) {
          e.preventDefault();
          
          const formData = new FormData(this);
          const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

          $.ajax({
              url: `/keranjang/tambah-ke-keranjang-ajax/${currentProductId}/`,
              type: 'POST',
              data: formData,
              processData: false,
              contentType: false,
              headers: {
                  'X-CSRFToken': csrftoken
              },
              success: function(response) {
                  closeModal();
                  Swal.fire({
                      title: 'Berhasil!',
                      text: 'Produk berhasil ditambahkan ke keranjang',
                      icon: 'success',
                      confirmButtonColor: '#FFAEBC'
                  }).then((result) => {
                      closeModal();
                  });
              },
              error: function(xhr, errmsg, err) {
                  Swal.fire({
                      title: 'Error!',
                      text: 'Gagal menambahkan produk ke keranjang',
                      icon: 'error',
                      confirmButtonColor: '#FFAEBC'
                  });
              }
          });
      });
  });
</script>

<script>
  async function getProductEntries(){
    return fetch("{% url 'edit:show_json' %}").then((res) => res.json())
  }
</script>

<script>
  async function refreshProductEntries(kategoriTerpilih = '') {
    document.getElementById("product_entry_cards").innerHTML = "";
    document.getElementById("product_entry_cards").className = "";
    const productEntries = await getProductEntries();
    let htmlString = "";
    let classNameString = "";

    //Ini akan filter produk berdasarkan kategorinya atau tampil semua (untuk opsi default)
    const filteredEntries = kategoriTerpilih 
        ? productEntries.filter(item => item.fields.kategori === kategoriTerpilih) 
        : productEntries;

    if (filteredEntries.length === 0) {
        classNameString = "flex flex-col items-center justify-center min-h-[24rem] p-6";
        htmlString = `
              <div class="flex flex-col items-center justify-center min-h-[24rem] p-6">
                <img src="{% static 'image/formal.png' %}" alt="Formal" class="w-32 h-32 mb-4"/>
                <p class="text-center text-gray-600 mt-4">Belum ada produk pada Mujur Reborn.</p>
              </div>
        `;
    }

    else {
        classNameString = "grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 w-full"
        filteredEntries.forEach((item) => {
            const nama_produk = DOMPurify.sanitize(item.fields.nama_produk)
            const kategori = DOMPurify.sanitize(item.fields.kategori)
            htmlString += `
            <div class="card fade-in relative w-full">
                <div class="product-card relative bg-white rounded-lg shadow-md overflow-hidden h-full">
                    <div class="card-header animated-gradient p-4">
                        <h3 class="product-name text-xl font-bold text-white mb-2">${nama_produk}</h3>
                        <span class="price-tag inline-block bg-white/90 backdrop-blur-sm text-blue-600 px-3 py-1 rounded-full text-sm font-semibold shadow-sm">
                            Rp${item.fields.harga}
                        </span>
                    </div>
                    
                    <div class="card-body p-4">
                        <div class="mb-4">
                            <p class="font-semibold text-gray-700 mb-1">Kategori</p>
                            <span class="text-gray-600">${kategori}</span>
                        </div>
                        
                        <div class="product-image-container mb-4">
                            <img src="${item.fields.gambar_produk}" 
                                alt="Gambar ${nama_produk}"
                                class="w-full h-48 object-cover rounded-lg shadow-sm">
                        </div>

                        <div class="action-buttons flex space-x-2">
                            <a href="" 
                              class="btn btn-edit flex items-center px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition duration-300">
                                Tambahkan ke Keranjang
                            </a>
                        </div>
                    </div>

                    <!-- Decorative floating icons -->
                    <svg class="floating-icon icon-1 absolute top-12 right-4 w-6 h-6 text-purple-200 opacity-50" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M21.41 11.58l-9-9C12.05 2.22 11.55 2 11 2H4c-1.1 0-2 .9-2 2v7c0 .55.22 1.05.59 1.42l9 9c.36.36.86.58 1.41.58.55 0 1.05-.22 1.41-.59l7-7c.37-.36.59-.86.59-1.41 0-.55-.23-1.06-.59-1.42zM5.5 7C4.67 7 4 6.33 4 5.5S4.67 4 5.5 4 7 4.67 7 5.5 6.33 7 5.5 7z"/>
                    </svg>
                    <svg class="floating-icon icon-2 absolute top-2 left-2 w-6 h-6 text-blue-200 opacity-50" viewBox="0 0 24 24">
                        <path fill="currentColor" d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
                    </svg>
                </div>
            </div>
            `;
        });
    }
    document.getElementById("product_entry_cards").className = classNameString;
    document.getElementById("product_entry_cards").innerHTML = htmlString;
}
refreshProductEntries();
</script>

<!--Script untuk memproses logika filter produk-->
<script>
document.getElementById("filter-kategori").addEventListener('change', async function(){
  const kategoriTerpilih = this.value;
  refreshProductEntries(kategoriTerpilih)
});
</script>

{% endblock content %}