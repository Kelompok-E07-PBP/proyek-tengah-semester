{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Mujur Reborn</title>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock meta %}
{% block content %}
{% include 'user_navbar.html' %}
<div id="addToCartModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full" style="z-index: 999;">
  <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
      <div class="mt-3">
          <h3 class="text-lg font-medium text-gray-900" id="modalProductName"></h3>
          <div class="mt-2">
              <p class="text-gray-500" id="modalProductPrice"></p>
              <form id="addToCartForm" class="mt-4">
                  {% csrf_token %}
                  <div class="mb-4">
                      <label class="block text-gray-700 text-sm font-bold mb-2" for="id_quantity">
                          Jumlah
                      </label>
                      <input type="number" name="quantity" id="id_quantity"
                          class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"
                          value="1" min="1">
                  </div>
                  <div class="flex items-center justify-between mt-4">
                      <button type="submit"
                          class="bg-[#FFAEBC] hover:bg-[#ff9eaf] text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                          Tambah ke Keranjang
                      </button>
                      <button type="button" onclick="closeModal()"
                          class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                          Batal
                      </button>
                  </div>
              </form>
          </div>
      </div>
  </div>
</div>

<div class="overflow-x-hidden px-4 md:px-8 pb-8 pt-24 min-h-screen bg-white flex flex-col">
  <div class="p-2 mb-6 relative">
    <div class="h-full w-full py-6  absolute top-0 left-0 z-20 md:hidden flex ">
      <div class="h-full min-w-4 bg-[#FFAEBC] mx-auto">
      </div>
    </div>
  </div>
  
    <div class="flex flex-row justify-between items-center">
      <div class="absolute bottom-4 right-4">
        <div class="flex rounded-md items-center bg-[#444445] py-1 px-2 w-fit opacity-80">
          <h1 class="text-white text-center text-sm">Last Login at: {{last_login}}</h1>
        </div>
      </div>
    </div>

    
    {% if not product_entries %}
    <div class="flex flex-col items-center justify-center min-h-[24rem] p-6">
        <img src="{% static 'image/formal.png' %}" alt="Formal" class="w-32 h-32 mb-4"/>
        <p class="text-center text-gray-600 mt-4">Belum ada produk pada Mujur Reborn.</p>
    </div>
    {% else %}
    <div class="columns-1 sm:columns-2 lg:columns-3 gap-6 space-y-6 w-full">
        {% for product_entry in product_entries %}
            {% include 'card_product.html' with product_entry=product_entry %}
        {% endfor %}
    </div>
    {% endif %}
</div>

<script>
  let currentProductId = null;

  function openModal(productId, productName, productPrice) {
      currentProductId = productId;
      document.getElementById('modalProductName').textContent = productName;
      document.getElementById('modalProductPrice').textContent = `Rp${productPrice}`;
      document.getElementById('addToCartModal').classList.remove('hidden');
  }

  function closeModal() {
      document.getElementById('addToCartModal').classList.add('hidden');
      document.getElementById('id_quantity').value = '1';
      currentProductId = null;
  }

  // AJAX form submission
  $(document).ready(function() {
      $('#addToCartForm').on('submit', function(e) {
          e.preventDefault();
          
          const formData = new FormData(this);
          const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

          $.ajax({
              url: `/keranjang/tambah-ke-keranjang-ajax/${currentProductId}/`,
              type: 'POST',
              data: formData,
              processData: false,
              contentType: false,
              headers: {
                  'X-CSRFToken': csrftoken
              },
              success: function(response) {
                  closeModal();
                  Swal.fire({
                      title: 'Berhasil!',
                      text: 'Produk berhasil ditambahkan ke keranjang',
                      icon: 'success',
                      confirmButtonColor: '#FFAEBC'
                  }).then((result) => {
                      closeModal();
                  });
              },
              error: function(xhr, errmsg, err) {
                  Swal.fire({
                      title: 'Error!',
                      text: 'Gagal menambahkan produk ke keranjang',
                      icon: 'error',
                      confirmButtonColor: '#FFAEBC'
                  });
              }
          });
      });
  });
</script>
{% endblock content %}